<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Brighter Minds Lessons</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Vue + Axios -->
  <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f2f2f2;
      padding-top: 20px;
    }
    header {
      margin-bottom: 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 15px;
    }
    .lesson-card img {
      height: 180px;
      object-fit: cover;
    }
    .cart-box {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.1);
    }
    .filters input {
      margin-bottom: 15px;
    }
  </style>
</head>
<body>
<div id="app" class="container">

  <!-- HEADER -->
  <header>
    <h1 class="text-primary">{{ sitename }}</h1>
    <button class="btn btn-warning" @click="showCart = !showCart">
      Cart ({{ cart.length }})
    </button>
  </header>

  <!-- LESSONS PAGE -->
  <section v-if="!showCart">
    <h2 class="mb-3">Available Lessons</h2>

    <!-- Filters -->
    <div class="row filters mb-4">
      <div class="col-md-6 mb-2">
        <input v-model="searchQuery" type="text" class="form-control" placeholder="Search by subject..." @input="loadLessons" />
      </div>
      <div class="col-md-6 mb-2">
        <input v-model="locationQuery" type="text" class="form-control" placeholder="Filter by location..." @input="loadLessons" />
      </div>
    </div>

    <div class="row">
      <div class="col-md-4 mb-4" v-for="lesson in filteredLessons" :key="lesson._id">
        <div class="card h-100 shadow-sm lesson-card">
          <img :src="lesson.image" class="card-img-top" alt="Lesson image">
          <div class="card-body d-flex flex-column">
            <h5 class="card-title">{{ lesson.subject }}</h5>
            <p class="card-text mb-1"><strong>Location:</strong> {{ lesson.location }}</p>
            <p class="card-text mb-1"><strong>Price:</strong> £{{ lesson.price }}</p>
            <p class="card-text mb-3"><strong>Spaces:</strong> {{ lesson.spaces }}</p>
            <button class="btn btn-primary mt-auto"
              :disabled="lesson.spaces === 0"
              @click="addToCart(lesson)">
              Add to Cart
            </button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- CART PAGE -->
  <section v-else>
    <h2 class="mb-3">Your Cart</h2>

    <div class="cart-box mx-auto">
      <div v-for="item in cart" :key="item._id" class="d-flex justify-content-between align-items-center mb-2">
        <span>{{ item.subject }} — £{{ item.price }}</span>
        <button class="btn btn-danger btn-sm" @click="removeFromCart(item)">Remove</button>
      </div>

      <hr>
      <h4>Total: £{{ cartTotal }}</h4>

      <!-- CHECKOUT FORM -->
      <h5 class="mt-3">Checkout</h5>
      <input v-model="name" type="text" class="form-control mb-2" placeholder="Your Name" />
      <input v-model="phone" type="text" class="form-control mb-3" placeholder="Phone Number" />

      <button class="btn btn-success w-100"
        :disabled="cart.length === 0 || !validForm"
        @click="checkout">
        Confirm Order
      </button>
    </div>
  </section>

</div>

<script>
const API_URL = "https://afterschoolsubjects-y6mr.onrender.com";

new Vue({
  el: "#app",
  data: {
    sitename: "Brighter Minds",
    lessons: [],
    cart: [],
    showCart: false,
    name: "",
    phone: "",
    searchQuery: "",
    locationQuery: ""
  },
  computed: {
    cartTotal() {
      return this.cart.reduce((total, item) => total + item.price, 0);
    },
    validForm() {
      return this.name.trim() !== "" && /^[0-9]+$/.test(this.phone);
    },
    filteredLessons() {
      return this.lessons.filter(l => {
        const matchSubject = !this.searchQuery || l.subject.toLowerCase().includes(this.searchQuery.toLowerCase());
        const matchLocation = !this.locationQuery || l.location.toLowerCase().includes(this.locationQuery.toLowerCase());
        return matchSubject && matchLocation;
      });
    }
  },
  methods: {
    async loadLessons() {
      try {
        const res = await axios.get(`${API_URL}/lessons`);
        this.lessons = res.data;
      } catch (err) {
        console.error('Error fetching lessons:', err);
      }
    },
    async addToCart(lesson) {
      if (lesson.spaces === 0) return;
      this.cart.push(lesson);
      lesson.spaces--;
      try {
        await axios.patch(`${API_URL}/lessons/${lesson._id}/spaces`, { change: -1 });
      } catch (err) { console.error(err); }
    },
    async removeFromCart(lesson) {
      const index = this.cart.indexOf(lesson);
      if (index !== -1) this.cart.splice(index, 1);
      lesson.spaces++;
      try {
        await axios.patch(`${API_URL}/lessons/${lesson._id}/spaces`, { change: 1 });
      } catch (err) { console.error(err); }
    },
    checkout() {
      alert(`Order confirmed for ${this.name}.\nThank you for your purchase!`);
      this.cart = [];
      this.name = "";
      this.phone = "";
      this.showCart = false;
      this.loadLessons();
    }
  },
  created() {
    this.loadLessons();
  }
});
</script>

<!-- Bootstrap JS (optional for components) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
